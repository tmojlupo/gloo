# Installing on Nomad

Installation on Nomad requires the following:

- [Levant](https://github.com/jrasell/levant) installed on your local machine
- [Docker](https://github.com/jrasell/levant), [Consul](https://www.consul.io), [Vault](https://www.vaultproject.io), and [Nomad](https://www.nomadproject.io/) installed on the target host machine (which can also be your local machine). A [Vagrantfile](.Vagrantfile) is provided that includes everything needed to run Nomad.

If you want to run locally on macOS, you will also need to install [Weave Network](https://www.weave.works/docs/net/latest/install/installing-weave/).

> Note: This nomad job is experimental and designed to be used with a specific Vault + Consul + Nomad setup.

## Download the Installation Files

This tutorial uses files stored on the Gloo Edge GitHub repository.

In order to install on Nomad, we'll want to clone the repository:

```shell
git clone https://github.com/solo-io/gloo
cd gloo/install/nomad
```

Installation files live in the `install/nomad` directory.

The Gloo Edge [Nomad Job](https://www.nomadproject.io/docs/job-specification/index.html) lives at `install/nomad/jobs/gloo.nomad`
[Levant Variables](https://github.com/jrasell/levant) for the Gloo Edge Nomad Job are generated by the `./demo-{local,vagrant}.sh` script into a `./variables.yaml` file.

## Run the complete Demo

If your environment is set up with `docker`, `nomad`, `consul`, `vault`, and `levant`, you can simply run
`demo-local.sh` to run a local demo of Gloo Edge routing to the PetStore Nomad.

## Running Nomad, Consul and Vault

### Running Nomad Locally

If you've installed Nomad/Consul/Vault locally, you can use `launch-consul-vault-nomad-dev.sh` to run them on your local system.

If running locally (without Vagrant) on macOS, you will need to install the [Weave Network](https://www.weave.works/docs/net/latest/install/installing-weave/).

```shell
weave launch
```

If running locally on Linux, you'll need to disable SELinux in order to run the demo (or add permission for docker containers to access `/` on their filesystem):

```shell
sudo setenforce 0
```

### Running Nomad Using Vagrant

The provided `Vagrantfile` will run Nomad, Consul, and Vault inside a VM on your local machine. Download and install [HashiCorp Vagrant](https://www.vagrantup.com).

Then run the following command:

```bash
vagrant up
```

Ports will be forwarded to your local system, allowing you to access services on the following ports (on `localhost`):

| service    | port  |
| ---------- | ----- |
| nomad      | 4646  |
| consul     | 8500  |
| vault      | 8200  |
| gloo/http  | 8080  |
| gloo/https | 8443  |
| gloo/admin | 19000 |

## Installing Gloo Edge on Nomad

The `./demo-{local,vagrant}.sh` scripts will create a `variables.yaml` file that look like the following. Where `${DOCKER_HOST}` should be set to `172.17.0.1` on Linux and `host.docker.internal` on macOS.

```yaml
datacenter: dc1

config:
  # the "namespace" where Gloo Edge will read/write configuration
  # change this for multiple installations of Gloo Edge
  namespace: gloo-system
  # the rate to poll Vault for secrets
  # maximum wait time on blocking requests to Consul
  refreshRate: 30s

consul:
  address: ${DOCKER_HOST}:8500

vault:
  address: http://${DOCKER_HOST}:8200
  token: root

gloo:
  # the port where Gloo Edge serves config to Envoy
  xdsPort: 9977
  image:
    registry: quay.io/solo-io
    repository: gloo
    tag: ${GLOO_VERSION}
  cpuLimit: 1000
  memLimit: 500
  bandwidthLimit: 10
  # number of instances of gloo config server
  replicas: 1

discovery:
  image:
    registry: quay.io/solo-io
    repository: discovery
    tag: ${GLOO_VERSION}
  cpuLimit: 500
  memLimit: 500
  bandwidthLimit: 10

gateway:
  image:
    registry: quay.io/solo-io
    repository: gateway
    tag: ${GLOO_VERSION}
  cpuLimit: 250
  memLimit: 250
  bandwidthLimit: 5

gatewayProxy:
  image:
    registry: quay.io/solo-io
    repository: gloo-envoy-wrapper
    tag: ${GLOO_VERSION}
  cpuLimit: 500
  memLimit: 500
  bandwidthLimit: 100
  # number of instances of gateway proxy
  replicas: 1
  httpPort: 8080
  httpsPort: 8443
  adminPort: 19000
  # expose the http and https ports
  # on the host machine
  exposePorts: true

# use this network plugin when running on mac
# dockerNetwork: weave
```

```bash
levant deploy \
    -var-file='variables.yaml' \
    -address <nomad-host>:<nomad-port> \
    -consul-address <nomad-host>:<nomad-port> \
    jobs/gloo.nomad
```

If running locally or with `vagrant`, you can omit the `address` flags:

```bash
levant deploy \
    -var-file='variables.yaml' \
    jobs/gloo.nomad
```

## Example

To run a test example, let's deploy the `petstore` application to Nomad as well:

### Deploy the PetStore on Nomad

```bash
levant deploy \
    -var-file='variables.yaml' \
    -address <nomad-host>:<nomad-port> \
    -consul-address <nomad-host>:<nomad-port> \
    jobs/petstore.nomad
```

If running locally or with `vagrant`, you can omit the `address` flags:

```bash
levant deploy \
    -var-file='variables.yaml' \
    jobs/petstore.nomad
```

### Create a Route to the PetStore

We can now use `glooctl` to create a route to the PetStore app we just deployed:

```bash
glooctl add route \
    --path-prefix / \
    --dest-name petstore \
    --prefix-rewrite /api/pets \
    --use-consul
```

```bash
{"level":"info","ts":"2019-08-22T17:15:24.117-0400","caller":"selectionutils/virtual_service.go:100","msg":"Created new default virtual service","virtualService":"virtual_host:<domains:\"*\" > status:<> metadata:<name:\"default\" namespace:\"gloo-system\" > "}
+-----------------+--------------+---------+------+---------+-----------------+--------------------------------+
| VIRTUAL SERVICE | DISPLAY NAME | DOMAINS | SSL  | STATUS  | LISTENERPLUGINS |             ROUTES             |
+-----------------+--------------+---------+------+---------+-----------------+--------------------------------+
| default         |              | *       | none | Pending |                 | / -> gloo-system.petstore      |
|                 |              |         |      |         |                 | (upstream)                     |
+-----------------+--------------+---------+------+---------+-----------------+--------------------------------+
```

> The `--use-consul` flag tells glooctl to write configuration to Consul Key-Value storage

And finally `curl` the Gateway Proxy:

```bash
curl <nomad-host>:8080/
```

If running on macOS or with Vagrant:

```bash
curl localhost:8080/
```

If running on Linux, use the Host IP on the `docker0` interface:

```bash
curl 172.17.0.1:8080/
```

```json
[{"id":1,"name":"Dog","status":"available"},{"id":2,"name":"Cat","status":"pending"}]
```

Congratulations! You've successfully deployed Gloo Edge to Nomad and created your first route.

Most of the existing tutorials for Gloo Edge can be reused with Nomad, however glooctl commands should be
used with the `--use-consul` flag.
